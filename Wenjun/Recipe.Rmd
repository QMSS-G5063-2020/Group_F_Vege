---
title: "Recipe"
author: "Wenjun Sun"
date: "2020/4/14"
output: 
  html_document:
    df_print: paged
    code_folding: show
    fig_width: 8
    fig_height: 6
---

```{r Setup, include=FALSE, results='hide', warning=FALSE}
library(knitr)
opts_chunk$set(fig.path="figures\\",
               cache.path="cache\\",
               cache=FALSE,
               echo=TRUE,
               message=FALSE,
               warning=FALSE) 
library(dplyr)
library(tidyverse)

library(httr)
library(jsonlite)

#library(tm)
library(wordcloud)
```

# Recipe {.tabset .tabset-fade .tabset-pills}

## Get the data

Extract the Top 1000 popular vegetarian recipes and their ingredient using [Spoonacular API](https://spoonacular.com/food-api). 

```{r eval=FALSE}
# the API key of Spoonacular is stored as environment variable "spoonacular_api_key" and "spoonacular_api_key_ljy"

# store and retrive key to environment 
#Sys.setenv(spoonacular_api_key = "")
#Sys.getenv("spoonacular_api_key")


combined <- data.frame(recipe_id = integer(),
                       recipe_name = character())

for (n in seq(0,900,100)) {
  request <- httr::GET(
    "https://api.spoonacular.com/recipes/complexSearch", 
    query = list(apiKey = Sys.getenv("spoonacular_api_key"),
                 diet = "vegetarian",
                 number = 100,
                 offset = n, # Spoonacular API only allows this to range from 0 to 900
                 sort = "popularity",
                 sortDirection = "desc"
                 )
    )  
  
  response <- jsonlite::fromJSON(httr::content(request, as = "text", encoding = "UTF-8"), flatten = TRUE)[[1]] %>%
  dplyr::select(recipe_id = id, recipe_name = title)
  
  combined <- rbind(combined, response)
  
  print(paste("extracted", n + 100, "recipes"))
}

save(combined, file = "combined_recipe_id.RData")
```

```{r}
combined <- combined %>%
  mutate(ingredient = NA)

for (i in 1:nrow(combined)) {
  recipe_id <- combined[i, "recipe_id"]
  request <- httr::GET(
    paste0("https://api.spoonacular.com/recipes/",recipe_id,"/ingredientWidget.json"), 
    query = list(apiKey = Sys.getenv("spoonacular_api_key")))
  
  response <- jsonlite::fromJSON(httr::content(request, as = "text", encoding = "UTF-8"), flatten = TRUE)[[1]] 
  
  ingredient <- response[["name"]]
  
  combined[i, "ingredient"] <- paste(ingredient, collapse = "//")
}

save(combined, file = "combined_recipe_id_ingredient.RData")
```

## Preprocess

```{r}
# combine all ingredient together
# measure: count 

allIngredient <- paste(combined$ingredient, collapse = "//")
ingredientList <- strsplit(allIngredient, "//")
ingredientDf <- data.frame(ingredientList, stringsAsFactors = FALSE)
names(ingredientDf) <- "ingredient"
ingredientDf <- ingredientDf %>%
  mutate(ingredient = case_when(ingredient %in% c("granulated sugar", "white sugar", "white granulated sugar") ~ "sugarr",
                                ingredient == "baking powder" ~ "baking soda",
                                ingredient %in% c("eggs", "whole eggs", "whole egg") ~ "egg",
                                ingredient == "ground cinnamon" ~ "cinnamon",
                                ingredient == "confectioners' sugar" ~ "powdered sugar",
                                ingredient == "garlic cloves" ~ "garlic",
                                ingredient %in% c("fresh lemon juice", "lemon (juice)") ~ "lemon juice",
                                ingredient == "avocados" ~ "avocado",
                                ingredient == "fresh lime juice" ~ "lime juice",
                                ingredient == "fresh blueberries" ~ "blueberries",
                                ingredient == "bananas" ~ "banana",
                                ingredient == "sea-salt" ~ "sea salt",
                                ingredient == "egg yolks" ~ "egg yolk",
                                ingredient == "egg whites" ~ "egg white",
                                TRUE ~ ingredient)) %>%
  group_by(ingredient) %>%
  summarise(cnt = n()) %>%
  ungroup() %>%
  filter(!ingredient %in% c("a mixture of the two", 
                            "add a little more if the batter appears to be too",
                            "as necessary"))

save(ingredientDf, file = "ingredientDf.RData")
```

```{r}
library(wordcloud)

wordcloudDf <- ingredientDf %>%
  filter(cnt > 1) %>%
  top_frac(n = -.98, wt = cnt) # remove some ingredient that is too common 

set.seed(1997)
wordcloud(wordcloudDf$ingredient, wordcloudDf$cnt, scale = c(1.5,.3), min.freq = 0,
          max.words = 100, 
          colors = brewer.pal(max(9, ncol(wordcloudDf$cnt)),"Reds"))
```



todo: clean ingredient
  sugar, salt, milk
  plural 
